name: Translate Content

on:
  workflow_dispatch:
    inputs:
      languages:
        description: 'Languages to translate (comma-separated, or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - es
          - vi
          - zh
          - ar
          - am
          - es,vi
          - vi,zh
          - ar,am
      content_types:
        description: 'Content types to translate (comma-separated, or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ui-strings
          - page-meta
          - policy-frontmatter
          - policy-bodies
          - grant-bodies
          - ui-strings,page-meta,policy-frontmatter
      dry_run:
        description: 'Dry run (no API calls, just show plan)'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # ── Build dynamic matrix from language input ──────────────────────────────
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [ "${{ inputs.languages }}" = "all" ]; then
            echo 'matrix={"language":["es","vi","zh","ar","am"]}' >> "$GITHUB_OUTPUT"
          else
            IFS=',' read -ra LANGS <<< "${{ inputs.languages }}"
            JSON=$(printf '"%s",' "${LANGS[@]}" | sed 's/,$//')
            echo "matrix={\"language\":[$JSON]}" >> "$GITHUB_OUTPUT"
          fi

  # ── Dry run (single job, no API calls) ────────────────────────────────────
  dry-run:
    if: inputs.dry_run == true
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - name: Extract content
        run: node scripts/translate/extract-content.js
      - name: Dry run translation
        run: node scripts/translate/translate.js --ci --dry-run
      - name: Summary
        run: |
          echo "### Dry Run Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "No API calls were made. Review the logs for the translation plan." >> "$GITHUB_STEP_SUMMARY"

  # ── Translate each language in its own job ─────────────────────────────────
  translate:
    needs: prepare
    if: inputs.dry_run == false
    strategy:
      matrix: ${{ fromJSON(needs.prepare.outputs.matrix) }}
      fail-fast: false
      max-parallel: 3
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci

      - name: Extract content
        run: node scripts/translate/extract-content.js

      - name: Run translation (${{ matrix.language }})
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          TYPES="${{ inputs.content_types }}"
          if [ "$TYPES" = "all" ]; then
            node scripts/translate/translate.js --ci --lang ${{ matrix.language }}
          else
            IFS=',' read -ra TYPE_ARRAY <<< "$TYPES"
            for type in "${TYPE_ARRAY[@]}"; do
              node scripts/translate/translate.js --ci --lang ${{ matrix.language }} --type "$type"
            done
          fi

      - name: Upload translation output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translations-${{ matrix.language }}
          path: scripts/translate/output/${{ matrix.language }}/
          if-no-files-found: ignore

  # ── Merge results, validate, hydrate, and open PR ──────────────────────────
  create-pr:
    needs: translate
    if: always() && inputs.dry_run == false && !cancelled()
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci

      - name: Extract English reference content
        run: node scripts/translate/extract-content.js

      - name: Download translation artifacts
        uses: actions/download-artifact@v4
        with:
          path: scripts/translate/output/
          pattern: translations-*
          merge-multiple: false

      - name: Reorganize artifacts into expected layout
        run: |
          cd scripts/translate/output
          for dir in translations-*; do
            lang="${dir#translations-}"
            if [ -d "$dir" ] && [ "$dir" != "$lang" ]; then
              mv "$dir" "$lang"
            fi
          done
          echo "Downloaded translations:"
          ls -la

      - name: Validate translations
        run: node scripts/translate/validate.js || echo "::warning::Validation found issues — review logs above."

      - name: Hydrate translations into codebase
        run: node scripts/translate/hydrate.js

      - name: Check for changes and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit."
            echo "### No Changes" >> "$GITHUB_STEP_SUMMARY"
            echo "All translations are already up to date." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          LANGS="${{ inputs.languages }}"
          TYPES="${{ inputs.content_types }}"
          DATE=$(date +%Y-%m-%d)
          BRANCH="translate/${DATE}-${LANGS//,/-}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "chore: update translations (${LANGS}, ${TYPES})"
          git push -u origin "$BRANCH"

          gh pr create \
            --title "chore: update translations (${LANGS})" \
            --body "## Translation Update

          **Languages:** \`${LANGS}\`
          **Content types:** \`${TYPES}\`
          **Model:** Gemini 2.0 Flash
          **Date:** ${DATE}

          ### Review checklist

          - [ ] Spot-check Spanish (es) translations
          - [ ] Spot-check Vietnamese (vi) translations
          - [ ] Spot-check Chinese (zh) translations
          - [ ] Spot-check Arabic (ar) — verify RTL punctuation
          - [ ] **Amharic (am) — must be reviewed by native speaker**
          - [ ] Search for \`[REVIEW:\` flags in Amharic files
          - [ ] Build passes (\`npm run build\`)

          ### What this PR contains

          Translated content generated by the [Translate Content workflow](../../actions/workflows/translate.yml).
          Files placed into:
          - \`src/i18n/<lang>.json\` — UI strings
          - \`src/i18n/policy-meta-<lang>.json\` — Policy titles/summaries
          - \`src/content/policies-<lang>/\` — Policy body markdown

          > **Note:** Amharic is a low-resource language for LLMs (12-20% quality gap vs English).
          > All Amharic translations should be reviewed by a native speaker before merging."

          echo "### Translation PR Created" >> "$GITHUB_STEP_SUMMARY"
          echo "A pull request has been created with the translated content." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Languages:** \`${{ inputs.languages }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Types:** \`${{ inputs.content_types }}\`" >> "$GITHUB_STEP_SUMMARY"
