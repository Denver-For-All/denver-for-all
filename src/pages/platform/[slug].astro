---
import Layout from '../../layouts/Layout.astro';
import EmailCapture from '../../components/EmailCapture.astro';
import PolicyActionScore from '../../components/PolicyActionScore.astro';
import PolicyActionCTA from '../../components/PolicyActionCTA.astro';
import DonationCTA from '../../components/DonationCTA.astro';
import { Icon } from 'astro-icon/components';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const policies = await getCollection('policies');
  return policies.map(policy => ({
    params: { slug: policy.slug },
    props: { policy },
  }));
}

const { policy } = Astro.props;
const { Content } = await policy.render();

let ContentEs: (typeof Content) | null = null;
try {
  const policyEs = await getEntry('policies-es', policy.slug);
  if (policyEs) {
    const rendered = await policyEs.render();
    ContentEs = rendered.Content;
  }
} catch {
  // No Spanish translation available for this policy
}

const hasPetition = !!policy.data.petition;
const hasFundingSources = policy.data.hasFundingSources;
const hasGrantProposal = !!policy.data.grantProposal;
const hasCouncilChampion = !!policy.data.councilChampion;

const categoryMap: Record<string, string> = {
  housing: 'Vivienda y Personas sin Hogar',
  labor: 'Trabajadores y Salarios',
  health: 'Salud',
  climate: 'Clima y Medio Ambiente',
  safety: 'Seguridad Pública',
  immigration: 'Inmigración',
  education: 'Educación',
  infrastructure: 'Infraestructura y Servicios',
  justice: 'Justicia Penal',
  democracy: 'Democracia y Gobernanza',
  economy: 'Pequeñas Empresas y Economía',
  community: 'Comunidad y Cultura',
};
const categoryEs = categoryMap[policy.data.category] || policy.data.category;
---

<Layout title={policy.data.title} description={policy.data.summary}>
  <article class="section">
    <div class="container container--narrow">
      <a href="/platform" class="back-link" data-en="← Back to Platform" data-es="← Volver a la Plataforma">
        ← Back to Platform
      </a>

      <header class="policy-header">
        <div class="policy-header__icon">
          <Icon name={`lucide:${policy.data.icon}`} size={32} />
        </div>
        <span class="policy-header__category" data-en={policy.data.category} data-es={categoryEs}>{policy.data.category}</span>
        <h1 data-en={policy.data.title} data-es={policy.data.titleEs}>{policy.data.title}</h1>
        <p class="policy-header__summary" data-en={policy.data.summary} data-es={policy.data.summaryEs}>
          {policy.data.summary}
        </p>
      </header>

      <div class="policy-content" data-lang="en">
        <Content />
      </div>
      {ContentEs && (
        <div class="policy-content" data-lang="es" style="display: none;">
          <ContentEs />
        </div>
      )}

      <DonationCTA context="This policy analysis" contextEs="Este análisis de política" />

      <footer class="policy-footer">
        <div class="policy-footer__action-grid">
          <div class="policy-footer__cta">
            <PolicyActionCTA
              actionTarget={policy.data.actionTarget}
              petition={policy.data.petition}
              grantProposal={policy.data.grantProposal}
              policyTitle={policy.data.title}
            />
          </div>
          <div class="policy-footer__score">
            <PolicyActionScore
              hasPetition={hasPetition}
              hasFundingSources={hasFundingSources}
              hasGrantProposal={hasGrantProposal}
              hasCouncilChampion={hasCouncilChampion}
            />
          </div>
        </div>

        <div class="policy-share">
          <h3 data-en="Share This Proposal" data-es="Comparte Esta Propuesta">Share This Proposal</h3>
          <div class="policy-share__links">
            <a
              href={`https://www.reddit.com/submit?url=https://denverforall.org/platform/${policy.slug}&title=${encodeURIComponent(policy.data.title)}`}
              target="_blank"
              rel="noopener"
              class="btn btn--secondary"
            >
              Reddit
            </a>
            <button class="btn btn--secondary" id="copy-link" data-en="Copy Link" data-es="Copiar Enlace">
              Copy Link
            </button>
          </div>
        </div>
      </footer>
    </div>
  </article>

  <section class="section section--alt">
    <div class="container">
      <EmailCapture />
    </div>
  </section>
</Layout>

<style>
  .back-link {
    display: inline-block;
    font-size: 0.9rem;
    margin-bottom: 2rem;
    color: var(--color-text-muted);
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .policy-header {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid var(--color-border);
  }

  .policy-header__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 56px;
    border-radius: 14px;
    background: var(--color-bg-alt);
    color: var(--color-primary);
    margin-bottom: 1rem;
  }

  .policy-header__category {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary);
  }

  .policy-header h1 {
    margin: 0.5rem 0 1rem;
  }

  .policy-header__summary {
    font-size: 1.15rem;
    color: var(--color-text-muted);
    line-height: 1.7;
  }

  .policy-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid var(--color-border);
  }

  .policy-footer__action-grid {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 1.5rem;
    margin-bottom: 2rem;
    align-items: start;
  }

  .policy-share {
    text-align: center;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .policy-share h3 {
    margin-bottom: 1rem;
  }

  .policy-share__links {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  @media (max-width: 768px) {
    .policy-footer__action-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.getElementById('copy-link')?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      const btn = document.getElementById('copy-link');
      if (btn) {
        const locale = localStorage.getItem('dfa-locale') || 'en';
        const copiedText = locale === 'es' ? '\u2713 ¡Copiado!' : '\u2713 Copied!';
        const restoreText = locale === 'es' ? (btn.getAttribute('data-es') || 'Copiar Enlace') : (btn.getAttribute('data-en') || 'Copy Link');
        btn.textContent = copiedText;
        setTimeout(() => { btn.textContent = restoreText; }, 2000);
      }
    } catch (_) {
      // Clipboard unavailable
    }
  });
</script>
