name: Translate Content

on:
  workflow_dispatch:
    inputs:
      languages:
        description: 'Languages to translate (comma-separated, or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - es
          - vi
          - zh
          - ar
          - am
          - es,vi
          - vi,zh
          - ar,am
      content_types:
        description: 'Content types to translate (comma-separated, or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ui-strings
          - page-meta
          - policy-frontmatter
          - policy-bodies
          - grant-bodies
          - ui-strings,page-meta,policy-frontmatter
      dry_run:
        description: 'Dry run (no API calls, just show plan)'
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  # ── Build dynamic matrix from language input ──────────────────────────────
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [ "${{ inputs.languages }}" = "all" ]; then
            echo 'matrix={"language":["es","vi","zh","ar","am"]}' >> "$GITHUB_OUTPUT"
          else
            IFS=',' read -ra LANGS <<< "${{ inputs.languages }}"
            JSON=$(printf '"%s",' "${LANGS[@]}" | sed 's/,$//')
            echo "matrix={\"language\":[$JSON]}" >> "$GITHUB_OUTPUT"
          fi

  # ── Dry run (single job, no API calls) ────────────────────────────────────
  dry-run:
    if: inputs.dry_run == true
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
      - run: npm ci
      - name: Extract content
        run: node scripts/translate/extract-content.js
      - name: Dry run translation
        run: node scripts/translate/translate.js --ci --dry-run
      - name: Summary
        run: |
          echo "### Dry Run Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "No API calls were made. Review the logs for the translation plan." >> "$GITHUB_STEP_SUMMARY"

  # ── Translate each language in its own job ─────────────────────────────────
  translate:
    needs: prepare
    if: inputs.dry_run == false
    strategy:
      matrix: ${{ fromJSON(needs.prepare.outputs.matrix) }}
      fail-fast: false
      max-parallel: 3
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci

      - name: Extract content
        run: node scripts/translate/extract-content.js

      - name: Run translation (${{ matrix.language }})
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          TYPES="${{ inputs.content_types }}"
          if [ "$TYPES" = "all" ]; then
            node scripts/translate/translate.js --ci --lang ${{ matrix.language }}
          else
            IFS=',' read -ra TYPE_ARRAY <<< "$TYPES"
            for type in "${TYPE_ARRAY[@]}"; do
              node scripts/translate/translate.js --ci --lang ${{ matrix.language }} --type "$type"
            done
          fi

      - name: Upload translation output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translations-${{ matrix.language }}
          path: scripts/translate/output/${{ matrix.language }}/
          if-no-files-found: ignore

  # ── Bundle all translations and provide download instructions ────────────
  package:
    needs: translate
    if: always() && inputs.dry_run == false && !cancelled()
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci

      - name: Extract English reference content
        run: node scripts/translate/extract-content.js

      - name: Download translation artifacts
        uses: actions/download-artifact@v4
        with:
          path: scripts/translate/output/
          pattern: translations-*
          merge-multiple: false

      - name: Reorganize artifacts into expected layout
        run: |
          cd scripts/translate/output
          for dir in translations-*; do
            lang="${dir#translations-}"
            if [ -d "$dir" ] && [ "$dir" != "$lang" ]; then
              mv "$dir" "$lang"
            fi
          done
          echo "Downloaded translations:"
          ls -la

      - name: Validate translations
        run: node scripts/translate/validate.js || echo "::warning::Validation found issues — review logs above."

      - name: Bundle translations for download
        uses: actions/upload-artifact@v4
        with:
          name: translations-bundle
          path: scripts/translate/output/
          if-no-files-found: warn

      - name: Write summary
        run: |
          LANGS="${{ inputs.languages }}"
          TYPES="${{ inputs.content_types }}"
          echo "### Translations Ready for Download" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Languages:** \`${LANGS}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Content types:** \`${TYPES}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "#### How to apply these translations" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Download the **translations-bundle** artifact from this workflow run" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Unzip and copy the language folders into \`translations/incoming/\` in your local repo" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Run \`npm run build\` — translations are automatically hydrated during the build" >> "$GITHUB_STEP_SUMMARY"
          echo "4. Review the changes, then commit and push" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Or hydrate manually: \`node scripts/translate/hydrate.js --source translations/incoming\`" >> "$GITHUB_STEP_SUMMARY"
