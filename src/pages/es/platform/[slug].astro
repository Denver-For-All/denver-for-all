---
import Layout from '../../../layouts/Layout.astro';
import EmailCapture from '../../../components/EmailCapture.astro';
import PolicyActionScore from '../../../components/PolicyActionScore.astro';
import PolicyActionCTA from '../../../components/PolicyActionCTA.astro';
import DonationCTA from '../../../components/DonationCTA.astro';
import { Icon } from 'astro-icon/components';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const policiesEs = await getCollection('policies-es');
  const policies = await getCollection('policies');
  const policyMap = new Map(policies.map(p => [p.slug, p]));

  return policiesEs.map(policyEs => {
    const policy = policyMap.get(policyEs.slug);
    return {
      params: { slug: policyEs.slug },
      props: { policyEs, policy },
    };
  }).filter(entry => entry.props.policy);
}

const { policyEs, policy } = Astro.props;
const { Content: ContentEs } = await policyEs.render();

const hasPetition = !!policy.data.petition;
const hasFundingSources = policy.data.hasFundingSources;
const hasGrantProposal = !!policy.data.grantProposal;
const hasCouncilChampion = !!policy.data.councilChampion;
const relatedLegislation = policy.data.relatedLegislation || [];

const categoryMap: Record<string, string> = {
  housing: 'Vivienda y Personas sin Hogar',
  labor: 'Trabajadores y Salarios',
  health: 'Salud',
  climate: 'Clima y Medio Ambiente',
  safety: 'Seguridad Pública',
  immigration: 'Inmigración',
  education: 'Educación',
  infrastructure: 'Infraestructura y Servicios',
  justice: 'Justicia Penal',
  democracy: 'Democracia y Gobernanza',
  economy: 'Pequeñas Empresas y Economía',
  community: 'Comunidad y Cultura',
};
const categoryEs = categoryMap[policy.data.category] || policy.data.category;

const ghRepo = 'Denver-For-All/denver-for-all';
const issueTitle = encodeURIComponent(`Feedback: ${policy.data.titleEs}`);
const issueBody = encodeURIComponent(`## Comentarios sobre la Política\n\n**Política:** [${policy.data.titleEs}](https://denverforall.org/es/platform/${policy.slug})\n**Categoría:** ${categoryEs}\n\n---\n\n### ¿Qué comentarios tienes?\n\n_Por favor describe tus comentarios, correcciones o sugerencias a continuación:_\n\n\n\n### Contexto adicional\n\n_Agrega cualquier otro contexto, fuentes de datos o referencias aquí._\n`);
const issueURL = `https://github.com/${ghRepo}/issues/new?title=${issueTitle}&body=${issueBody}&labels=feedback,policy`;
---

<Layout title={policy.data.titleEs} description={policy.data.summaryEs} locale="es" image={`/og/${policy.data.category}.png`}>
  <article class="section">
    <div class="container container--narrow">
      <a href="/es/platform" class="back-link">
        ← Volver a la Plataforma
      </a>

      <header class="policy-header">
        <div class="policy-header__icon">
          <Icon name={`lucide:${policy.data.icon}`} size={32} />
        </div>
        <span class="policy-header__category">{categoryEs}</span>
        <h1>{policy.data.titleEs}</h1>
        <p class="policy-header__summary">
          {policy.data.summaryEs}
        </p>
      </header>

      <div class="policy-content">
        <ContentEs />
      </div>

      {relatedLegislation.length > 0 && (
        <div class="related-legislation">
          <h2>Legislación Estatal Relacionada</h2>
          <p class="related-legislation__intro">
            Estos proyectos de ley en la Asamblea General de Colorado (sesión 2026) se alinean con esta propuesta de política. Contacta a tus legisladores estatales para expresar tu apoyo.
          </p>
          <div class="legislation-cards">
            {relatedLegislation.map((bill) => (
              <div class="legislation-card">
                <div class="legislation-card__header">
                  <span class="legislation-card__number">{bill.billNumber}</span>
                  <span class="legislation-card__session">{bill.session}</span>
                </div>
                <h3 class="legislation-card__title">{bill.title}</h3>
                <p class="legislation-card__status">
                  <Icon name="lucide:clock" size={14} />
                  {bill.status}
                </p>
                <div class="legislation-card__actions">
                  {bill.url && (
                    <a href={bill.url} target="_blank" rel="noopener" class="btn btn--secondary btn--sm">Seguir Proyecto</a>
                  )}
                  <a href="/es/tools/resistbot" class="btn btn--primary btn--sm">Actúa</a>
                </div>
              </div>
            ))}
          </div>
          <a href="/es/tools/sponsor-tracker" class="related-legislation__more">Ver todos los patrocinadores alineados →</a>
        </div>
      )}

      <DonationCTA context="Este análisis de política" contextEs="Este análisis de política" />

      <footer class="policy-footer">
        <div class="policy-footer__action-grid">
          <div class="policy-footer__cta">
            <PolicyActionCTA
              actionTarget={policy.data.actionTarget}
              petition={policy.data.petition}
              grantProposal={policy.data.grantProposal}
              policyTitle={policy.data.titleEs}
            />
          </div>
          <div class="policy-footer__score">
            <PolicyActionScore
              hasPetition={hasPetition}
              hasFundingSources={hasFundingSources}
              hasGrantProposal={hasGrantProposal}
              hasCouncilChampion={hasCouncilChampion}
            />
          </div>
        </div>

        <div class="policy-share">
          <h3>Comparte Esta Propuesta</h3>
          <div class="policy-share__links">
            <a
              href={`https://www.reddit.com/submit?url=https://denverforall.org/es/platform/${policy.slug}&title=${encodeURIComponent(policy.data.titleEs)}`}
              target="_blank"
              rel="noopener"
              class="btn btn--secondary"
            >
              Reddit
            </a>
            <button class="btn btn--secondary" id="copy-link">
              Copiar Enlace
            </button>
          </div>
        </div>

        <div class="policy-feedback">
          <h3>Ayuda a Mejorar Esta Propuesta</h3>
          <p>
            ¿Encontraste un error, tienes una fuente de datos o quieres sugerir cambios? Esta plataforma es de código abierto e impulsada por la comunidad.
          </p>
          <div class="policy-feedback__links">
            <a
              href={issueURL}
              target="_blank"
              rel="noopener"
              class="btn btn--secondary"
            >
              Abrir un Issue
            </a>
            <a
              href={`https://github.com/${ghRepo}/blob/main/src/content/policies-es/${policy.slug}.md`}
              target="_blank"
              rel="noopener"
              class="btn btn--secondary"
            >
              Ver Código Fuente
            </a>
          </div>
        </div>
      </footer>
    </div>
  </article>

  <section class="section section--alt">
    <div class="container">
      <EmailCapture />
    </div>
  </section>
</Layout>

<style>
  .back-link {
    display: inline-block;
    font-size: 0.9rem;
    margin-bottom: 2rem;
    color: var(--color-text-muted);
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .policy-header {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid var(--color-border);
  }

  .policy-header__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 56px;
    border-radius: 14px;
    background: var(--color-bg-alt);
    color: var(--color-primary);
    margin-bottom: 1rem;
  }

  .policy-header__category {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary);
  }

  .policy-header h1 {
    margin: 0.5rem 0 1rem;
  }

  .policy-header__summary {
    font-size: 1.15rem;
    color: var(--color-text-muted);
    line-height: 1.7;
  }

  .policy-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid var(--color-border);
  }

  .policy-footer__action-grid {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 1.5rem;
    margin-bottom: 2rem;
    align-items: start;
  }

  .policy-share {
    text-align: center;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .policy-share h3 {
    margin-bottom: 1rem;
  }

  .policy-share__links {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .policy-feedback {
    text-align: center;
    padding-top: 2rem;
    margin-top: 1rem;
    border-top: 1px solid var(--color-border);
  }

  .policy-feedback h3 {
    margin-bottom: 0.5rem;
  }

  .policy-feedback p {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  .policy-feedback__links {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .related-legislation {
    margin-top: 3rem;
    padding: 2rem;
    background: var(--color-bg-alt);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
  }

  .related-legislation h2 {
    margin: 0 0 0.5rem;
    font-size: 1.25rem;
  }

  .related-legislation__intro {
    color: var(--color-text-muted);
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
  }

  .legislation-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
  }

  .legislation-card {
    padding: 1.25rem;
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
  }

  .legislation-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .legislation-card__number {
    font-family: var(--font-mono, monospace);
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--color-primary);
  }

  .legislation-card__session {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    background: var(--color-primary-light);
    color: var(--color-primary-dark);
    letter-spacing: 0.03em;
  }

  .legislation-card__title {
    font-size: 0.9rem;
    margin: 0 0 0.5rem;
    line-height: 1.4;
  }

  .legislation-card__status {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-bottom: 0.75rem;
  }

  .legislation-card__actions {
    display: flex;
    gap: 0.5rem;
  }

  .btn--sm {
    font-size: 0.75rem;
    padding: 0.35rem 0.75rem;
  }

  .related-legislation__more {
    display: block;
    text-align: center;
    margin-top: 1.25rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--color-primary);
  }

  @media (max-width: 768px) {
    .policy-footer__action-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.getElementById('copy-link')?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      const btn = document.getElementById('copy-link');
      if (btn) {
        btn.textContent = '\u2713 ¡Copiado!';
        setTimeout(() => { btn.textContent = 'Copiar Enlace'; }, 2000);
      }
    } catch (_) {
      // Clipboard unavailable
    }
  });
</script>
